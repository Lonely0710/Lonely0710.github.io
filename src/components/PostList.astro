---
import type { CollectionEntry } from 'astro:content'
import ArchiveIcon from '@/assets/icons/archive-icon.svg'
import ResearchIcon from '@/assets/icons/llms-icon.svg'
import MusicIcon from '@/assets/icons/music-icon.svg'
import PinIcon from '@/assets/icons/pin-icon.svg'
import QuoteIcon from '@/assets/icons/quote-icon.svg'
import RecordingIcon from '@/assets/icons/recording-icon.svg'
import PostDate from '@/components/PostDate.astro'
import PostReadingTime from '@/components/PostReadingTime.astro'
import { defaultLocale } from '@/config'
import { getListAbstract } from '@/utils/description'
import { isHomePage } from '@/utils/page'

type Post = CollectionEntry<'posts'> & {
  remarkPluginFrontmatter: {
    minutes: number
  }
}

const { posts, lang, pinned = false } = Astro.props
const isHome = isHomePage(Astro.url.pathname)

export interface Props {
  posts: Post[]
  lang: string
  pinned?: boolean
}

function getPostPath(post: Post) {
  const slug = post.data.abbrlink || post.id

  if (lang === defaultLocale) {
    return `/posts/${slug}/`
  }

  return `/${lang}/posts/${slug}/`
}

function getTagIcon(tag: string) {
  const normalizedTag = tag.toLowerCase()
  if (normalizedTag === 'archive')
return ArchiveIcon
  if (normalizedTag === 'music')
return MusicIcon
  if (normalizedTag === 'recording')
return RecordingIcon
  if (normalizedTag === 'research')
return ResearchIcon
  return null
}
---

<ul>
  {
    posts.map((post) => {
      const firstTag = post.data.tags && post.data.tags.length > 0 ? post.data.tags[0] : null
      const TagIcon = firstTag ? getTagIcon(firstTag) : null
      return (
      <li class="mb-5.5" lg={isHome ? 'mb-10' : ''}>
        {/* first tag */}
        {firstTag && (
          <span class="float-right ml-2 inline-flex items-center gap-1 rounded-xl bg-secondary/2 px-2.5 py-0.5 text-3 c-secondary shadow-sm ring-1 ring-secondary/10 ring-inset dark:bg-secondary/10 dark:text-gray-300 dark:ring-white/10">
            {TagIcon && (
              <TagIcon
                aria-hidden="true"
                class="h-3.5 w-3.5"
                fill="currentColor"
              />
            )}
            <span>{firstTag}</span>
          </span>
        )}
        {/* post title */}
        <h3 class="inline transition-colors hover:c-primary">
          <a
            class="cjk:tracking-0.02em"
            lg={isHome ? 'font-medium text-4.5' : ''}
            href={getPostPath(post)}
            transition:name={`post-${post.data.abbrlink || post.id}${lang ? `-${lang}` : ''}`}
            data-disable-theme-transition
          >
            {post.data.title}
          </a>
          {/* pinned icon */}
          {pinned && (
            <PinIcon
              aria-hidden="true"
              class="ml-0.25em inline-block aspect-square w-0.98em translate-y--0.1em lg:(w-1.05em translate-y--0.15em)"
              fill="currentColor"
            />
          )}
        </h3>

        {/* mobile post time */}
        <div
          class="py-0.8 text-3.5 font-time lg:hidden"
          transition:name={`time-${post.data.abbrlink || post.id}${lang ? `-${lang}` : ''}`}
          data-disable-theme-transition
        >
          <PostDate
            date={post.data.published}
          />
          <PostReadingTime
            minutes={post.remarkPluginFrontmatter.minutes}
          />
        </div>

        {/* desktop post time */}
        <div class={`hidden text-3.65 font-time ${isHome ? 'lg:block lg:mt-1' : 'lg:ml-2.5 lg:inline'}`}>
          <PostDate
            date={post.data.published}
          />
          <PostReadingTime
            minutes={post.remarkPluginFrontmatter.minutes}
          />
        </div>

        {/* cover + desktop post abstract (home only) */}
        {isHome && (
          <div>
            {post.data.cover && (
              <a
                href={getPostPath(post)}
                aria-label={post.data.title}
                class="block"
              >
                <div
                  class="relative mb-3 w-full overflow-hidden rounded-2"
                  style="padding-top: 40%"
                >
                  <img
                    src={post.data.cover}
                    alt={post.data.title}
                    class="absolute inset-0 h-full w-full object-cover"
                    loading="lazy"
                  />
                </div>
              </a>
            )}
            <div class="heti hidden" lg="mt-2.25 block">
              <p>
                <QuoteIcon
                  aria-hidden="true"
                  class="mr-2 inline-block aspect-square w-1em translate-y--0.1em text-gray-500 dark:text-gray-400"
                  fill="currentColor"
                />
                {getListAbstract(post)}
              </p>
            </div>
          </div>
        )}
      </li>
    )
    })
  }
</ul>
